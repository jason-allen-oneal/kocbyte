<?php

require($root_path . 'inc/startup.' . $phpEx);

if(file_exists($root_path . 'inc/config.' . $phpEx)){
	require($root_path . 'inc/config.' . $phpEx);
}

if(!defined('INSTALLED')){
	// Redirect the user to the installer
	require($root_path . 'lib/functions.' . $phpEx);

	// We have to generate a full HTTP/1.1 header here since we can't guarantee to have any of the information
	// available as used by the redirect function
	$server_name = (!empty($_SERVER['HTTP_HOST'])) ? strtolower($_SERVER['HTTP_HOST']) : ((!empty($_SERVER['SERVER_NAME'])) ? $_SERVER['SERVER_NAME'] : getenv('SERVER_NAME'));
	$server_port = (!empty($_SERVER['SERVER_PORT'])) ? (int) $_SERVER['SERVER_PORT'] : (int) getenv('SERVER_PORT');
	$secure = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] == 'on') ? 1 : 0;

	$script_name = (!empty($_SERVER['PHP_SELF'])) ? $_SERVER['PHP_SELF'] : getenv('PHP_SELF');
	if(!$script_name){
		$script_name = (!empty($_SERVER['REQUEST_URI'])) ? $_SERVER['REQUEST_URI'] : getenv('REQUEST_URI');
	}

	// $root_path accounts for redirects from e.g. /adm
	$script_path = trim(dirname($script_name)) . '/' . $root_path . 'install/index.' . $phpEx;
	// Replace any number of consecutive backslashes and/or slashes with a single slash
	// (could happen on some proxy setups and/or Windows servers)
	$script_path = preg_replace('#[\\\\/]{2,}#', '/', $script_path);
	// Eliminate . and .. from the path
	$script_path = site_clean_path($script_path);

	$url = (($secure) ? 'https://' : 'http://') . $server_name;

	if($server_port && (($secure && $server_port <> 443) || (!$secure && $server_port <> 80))){
		// HTTP HOST can carry a port number...
		if(strpos($server_name, ':') === false){
			$url .= ':' . $server_port;
		}
	}

	$url .= $script_path;
	header('Location: ' . $url);
	exit;
}

if(defined('DEBUG_EXTRA')){
	$base_memory_usage = 0;
	if(function_exists('memory_get_usage')){
		$base_memory_usage = memory_get_usage();
	}
}

// Load Extensions
// dl() is deprecated and disabled by default as of PHP 5.3.
if(!empty($load_extensions) && function_exists('dl')){
	$load_extensions = explode(',', $load_extensions);

	foreach($load_extensions as $extension){
		@dl(trim($extension));
	}
}

// Include files
require($root_path . 'lib/acm/acm_' . $acm_type . '.' . $phpEx);
require($root_path . 'lib/cache.' . $phpEx);
require($root_path . 'lib/template.' . $phpEx);
require($root_path . 'lib/session.' . $phpEx);
require($root_path . 'lib/auth.' . $phpEx);

require($root_path . 'lib/functions.' . $phpEx);

require($root_path . 'inc/constants.' . $phpEx);
require($root_path . 'lib/db/' . $dbms . '.' . $phpEx);
require($root_path . 'lib/utf/utf_tools.' . $phpEx);

// Set PHP error handler to ours
set_error_handler('msg_handler');

// Instantiate some basic classes
$user		= new user();
$auth		= new auth();
$template	= new template();
$cache		= new cache();
$db			= new $sql_db();

// Connect to DB
$db->sql_connect($dbhost, $dbuser, $dbpasswd, $dbname, $dbport, false, defined('SITE_DB_NEW_LINK') ? SITE_DB_NEW_LINK : false);

// We do not need this any longer, unset for safety purposes
unset($dbpasswd);

// Grab global variables, re-cache if necessary
$config = $cache->obtain_config();

$officers = array(1 => 'Chancellor', 'Vice Chancellor', 'Officer', 'Member');

$serverList = array(
  0 => NULL,
  1 => 'Arthur',
  2 => 'Excalibur',
  3 => 'Galatine',
  4 => 'Arondight',
  5 => 'Caliburn',
  6 => 'Rhon',
  7 => 'Annwyn',
  8 => 'Clarent',
  9 => 'Pridwen',
  10 => 'Goswhit',
  11 => 'Llamrei',
  12 => 'Caval',
  13 => 'Celidon',
  14 => 'Badon',
  15 => 'Glessic',
  16 => 'Culwich',
  17 => 'Arthur17',
  18 => 'Excalibur18',
  19 => 'Galatine19',
  20 => 'Arondight20',
  21 => 'Caliburn21',
  22 => 'Rhon22',
  23 => 'Annwyn23',
  24 => 'Clarent24',
  25 => 'Llamrei25',
  26 => 'Caval26',
  27 => 'Celidon27',
  28 => 'Badon28',
  29 => 'Glessic29',
  30 => 'Culwich30',
  31 => 'Pridwen31',
  32 => 'Goswhit32',
  33 => 'Arthur33',
  34 => 'Excalibur34',
  35 => 'Galatine35',
  36 => 'Arondight36',
  37 => 'Caliburn37',
  38 => 'Rhon38',
  39 => 'Annwyn39',
  40 => 'Clarent40',
  41 => 'LLamrei41',
  42 => 'Caval42',
  43 => 'Celidon43',
  44 => 'Badon44',
  45 => 'Glessic45',
  46 => 'Culwich46',
  47 => 'Pridwen47',
  48 => 'Goswhit48',
  49 => 'Arthur49',
  50 => 'Excalibur50',
  51 => 'Galatine51',
  52 => 'Arondight52',
  53 => 'Caliburn53',
  54 => 'Rhon54',
  55 => 'Annwyn55',
  56 => 'Clarent56',
  57 => 'LLamrei57',
  58 => 'Caval58',
  59 => 'Celidon59',
  60 => 'Badon60',
  61 => 'Glessic61',
  62 => 'Culwich62',
  63 => 'Pridwen63',
  64 => 'Goswhit64',
  65 => 'Arthur65',
  66 => 'Excalibur66',
  67 => 'Galatine67',
  68 => 'Arondight68',
  69 => 'Caliburn69',
  70 => 'Rhon70',
  71 => 'Annwyn71',
  72 => 'Clarent72',
  73 => 'LLamrei73',
  74 => 'Caval74',
  75 => 'Celidon75',
  76 => 'Badon76',
  77 => 'Glessic77',
  78 => 'Culwich78',
  79 => 'Pridwen79',
  80 => 'Goswhit80',
  81 => 'Arthur81',
  82 => 'Excalibur82',
  83 => 'Galatine83',
  84 => 'Arondight84',
  85 => 'Caliburn85',
  86 => 'Rhon86',
  87 => 'Annwyn87',
  88 => 'Clarent88',
  89 => 'LLamrei89',
  90 => 'Caval90',
  91 => 'Celidon91',
  92 => 'Badon92',
  93 => 'Glessic93',
  94 => 'Culwich94',
  95 => 'Pridwen95',
  96 => 'Goswhit96',
  97 => 'Arthur97',
  98 => 'Excalibur98',
  99 => 'Galatine99',
  100 => 'Arondight100',
  101 => 'Caliburn101',
  102 => 'Rhon102',
  103 => 'Annwyn103',
  104 => 'Clarent104',
  105 => 'LLamrei105',
  106 => 'Caval106',
  107 => 'Celidon107',
  108 => 'Badon108',
  109 => 'Glessic109',
  110 => 'Culwich110',
  111 => 'Pridwen111',
  112 => 'Goswhit112',
  113 => 'Arthur113',
  114 => 'Excalibur114',
  115 => 'Galatine115',
  116 => 'Arondight116',
  117 => 'Caliburn117',
  118 => 'Rhon118',
  119 => 'Annwyn119',
  120 => 'Clarent120',
  121 => 'LLamrei121',
  122 => 'Caval122',
  123 => 'Celidon123',
  124 => 'Badon124',
  125 => 'Glessic125',
  126 => 'Culwich126',
  127 => 'Pridwen127',
  128 => 'Goswhit128',
  129 => 'Arthur129',
  130 => 'Excalibur130',
  131 => 'Galatine131',
  132 => 'Arondight132',
  133 => 'Caliburn133',
  134 => 'Rhon134',
  135 => 'Annwyn135',
  136 => 'Clarent136',
  137 => 'LLamrei137',
  138 => 'Caval138',
  139 => 'Celidon139',
  140 => 'Badon140',
  141 => 'Glessic141',
  142 => 'Culwich142',
  143 => 'Pridwen143',
  144 => 'Goswhit144',
  145 => 'Arthur145',
  146 => 'Excalibur146',
  147 => 'Galatine147',
  148 => 'Arondight148',
  149 => 'Caliburn149',
  150 => 'Rhon150',
  151 => 'Annwyn151',
  152 => 'Clarent152',
  153 => 'LLamrei153',
  154 => 'Caval154',
  155 => 'Celidon155',
  156 => 'Badon156',
  157 => 'Glessic157',
  158 => 'Culwich158',
  159 => 'Pridwen159',
  160 => 'Goswhit160',
  161 => 'Arthur161',
  162 => 'Excalibur162',
  163 => 'Galatine163',
  164 => 'Arondight164',
  165 => 'Caliburn165',
  166 => 'Rhon166',
  167 => 'Annwyn167',
  168 => 'Clarent168',
  169 => 'LLamrei169',
  170 => 'Caval170',
  171 => 'Celidon171',
  172 => 'Badon172',
  173 => 'Glessic173',
  174 => 'Culwich174',
  175 => 'Pridwen175',
  176 => 'Goswhit176',
  177 => 'Arthur177',
  178 => 'Excalibur178',
  179 => 'Galatine179',
  180 => 'Arondight180',
  181 => 'Caliburn181',
  182 => 'Rhon182',
  183 => 'Annwyn183',
  184 => 'Clarent184',
  185 => 'LLamrei185',
  186 => 'Caval186',
  187 => 'Celidon187',
  188 => 'Badon188',
  189 => 'Glessic189',
  190 => 'Culwich190',
  191 => 'Pridwen191',
  192 => 'Goswhit192',
  193 => 'Arthur193',
  194 => 'Excalibur194',
  195 => 'Galatine195',
  196 => 'Arondight196',
  197 => 'Caliburn197',
  198 => 'Rhon198',
  199 => 'Annwyn199',
  200 => 'Clarent200',
  201 => 'LLamrei201',
  202 => 'Caval202',
  203 => 'Celidon203',
  204 => 'Badon204',
  205 => 'Glessic205',
  206 => 'Culwich206',
  207 => 'Pridwen207',
  208 => 'Goswhit208',
  209 => 'Arthur209',
  210 => 'Excalibur210',
  211 => 'Galatine211',
  212 => 'Arondight212',
  213 => 'Caliburn213',
  214 => 'Rhon214',
  215 => 'Annwyn215',
  216 => 'Clarent216',
  217 => 'LLamrei217',
  218 => 'Caval218',
  219 => 'Celidon219',
  220 => 'Badon220',
  221 => 'Glessic221',
  222 => 'Culwich222',
  223 => 'Pridwen223',
  224 => 'Goswhit224',
  225 => 'Arthur225',
  226 => 'Excalibur226',
  227 => 'Galatine227',
  228 => 'Arondight228',
  229 => 'Caliburn229',
  230 => 'Rhon230',
  231 => 'Annwyn231',
  232 => 'Clarent232',
  233 => 'LLamrei233',
  234 => 'Caval234',
  235 => 'Celidon235',
  236 => 'Badon236',
  237 => 'Glessic237',
  238 => 'Culwich238',
  239 => 'Pridwen239',
  240 => 'Goswhit240',
  241 => 'Arthur241',
  242 => 'Excalibur242',
  243 => 'Galatine243',
  244 => 'Arondight244',
  245 => 'Caliburn245',
  246 => 'Rhon246',
  247 => 'Annwyn247',
  248 => 'Clarent248',
  249 => 'LLamrei249',
  250 => 'Caval250',
  251 => 'Celidon251',
  252 => 'Badon252',
  253 => 'Glessic253',
  254 => 'Culwich254',
  255 => 'Pridwen255',
  256 => 'Goswhit256',
  257 => 'Arthur257',
  258 => 'Excalibur258',
  259 => 'Galatine259',
  260 => 'Arondight260',
  261 => 'Caliburn261',
  262 => 'Rhon262',
  263 => 'Annwyn263',
  264 => 'Clarent264',
  265 => 'LLamrei265',
  266 => 'Caval266',
  267 => 'Celidon267',
  268 => 'Badon268',
  269 => 'Glessic269',
  270 => 'Culwich270',
  271 => 'Pridwen271',
  272 => 'Goswhit272',
  273 => 'Arthur273',
  274 => 'Excalibur274',
  275 => 'Galatine275',
  276 => 'Arondight276',
  277 => 'Caliburn277',
  278 => 'Rhon278',
  279 => 'Annwyn279',
  280 => 'Clarent280',
  281 => 'LLamrei281',
  282 => 'Caval282',
  283 => 'Celidon283',
  284 => 'Badon284',
  285 => 'Glessic285',
  286 => 'Culwich286',
  287 => 'Pridwen287',
  288 => 'Goswhit288',
  289 => 'Arthur289',
  290 => 'Excalibur290',
  291 => 'Galatine291',
  292 => 'Arondight292',
  293 => 'Caliburn293',
  294 => 'Rhon294',
  295 => 'Annwyn295',
  296 => 'Clarent296',
  297 => 'LLamrei297',
  298 => 'Caval298',
  299 => 'Celidon299',
  300 => 'Badon300',
  301 => 'Glessic301',
  302 => 'Culwich302',
  303 => 'Pridwen303',
  304 => 'Goswhit304',
  305 => 'Arthur305',
  306 => 'Excalibur306',
  307 => 'Galatine307',
  308 => 'Arondight308',
  309 => 'Caliburn309',
  310 => 'Rhon310',
  311 => 'Annwyn311',
  312 => 'Clarent312',
  313 => 'LLamrei313',
  314 => 'Caval314',
  315 => 'Celidon315',
  316 => 'Badon316',
  317 => 'Glessic317',
  318 => 'Culwich318',
  319 => 'Pridwen319',
  320 => 'Goswhit320',
  321 => 'Arthur321',
  322 => 'Excalibur322',
  323 => 'Galatine323',
  324 => 'Arondight324',
  325 => 'Caliburn325',
  326 => 'Rhon326',
  327 => 'Annwyn327',
  328 => 'Clarent328',
  329 => 'LLamrei329',
  330 => 'Caval330',
  331 => 'Celidon331',
  332 => 'Badon332',
  333 => 'Glessic333',
  334 => 'Culwich334',
  335 => 'Pridwen335',
  336 => 'Goswhit336',
  337 => 'Arthur337',
  338 => 'Excalibur338',
  339 => 'Galatine339',
  340 => 'Arondight340',
  341 => 'Caliburn341',
  342 => 'Rhon342',
  343 => 'Annwyn343',
  344 => 'Clarent344',
  345 => 'LLamrei345',
  346 => 'Caval346',
  347 => 'Celidon347',
  348 => 'Badon348',
  349 => 'Glessic349',
  350 => 'Culwich350',
  351 => 'Pridwen351',
  352 => 'Goswhit352',
  353 => 'Arthur353',
  354 => 'Excalibur354',
  355 => 'Galatine355',
  356 => 'Arondight356',
  357 => 'Caliburn357',
  358 => 'Rhon358',
  359 => 'Annwyn359',
  360 => 'Clarent360',
  361 => 'LLamrei361',
  362 => 'Caval362',
  363 => 'Celidon363',
  364 => 'Badon364',
  365 => 'Glessic365',
  366 => 'Culwich366',
  367 => 'Pridwen367',
  368 => 'Goswhit368',
  369 => 'Arthur369',
  370 => 'Excalibur370',
  371 => 'Galatine371',
  372 => 'Arondight372',
  373 => 'Caliburn373',
  374 => 'Rhon374',
  375 => 'Annwyn375',
  376 => 'Clarent376',
  377 => 'LLamrei377',
  378 => 'Caval378',
  379 => 'Celidon379',
  380 => 'Badon380',
  381 => 'Glessic381',
  382 => 'Culwich382',
  383 => 'Pridwen383',
  384 => 'Goswhit384',
  385 => 'Arthur385',
  386 => 'Excalibur386',
  387 => 'Galatine387',
  388 => 'Arondight388',
  389 => 'Caliburn389',
  390 => 'Rhon390',
  391 => 'Annwyn391',
  392 => 'Clarent392',
  393 => 'LLamrei393',
  394 => 'Caval394',
  395 => 'Celidon395',
  396 => 'Badon396',
  397 => 'Glessic397',
  398 => 'Culwich398',
  399 => 'Pridwen399',
  400 => 'Goswhit400',
  401 => 'Arthur401',
  402 => 'Excalibur402',
  403 => 'Galantine403',
  404 => 'Arondight404',
  405 => 'Caliburn405',
  406 => 'Rhon406',
  407 => 'Annwyn407',
  408 => 'Clarent408',
  409 => 'LLamrei409',
  410 => 'Caval410',
  411 => 'Celidon411',
  412 => 'Badon412',
  413 => 'Glessic413',
  414 => 'Culwich414',
  415 => 'Pridwen415',
  416 => 'Goswhit416',
  417 => 'Arthur417',
  418 => 'Excalibur418',
  419 => 'Galantine419',
  420 => 'Arondight420',
  421 => 'Sylfas_Place421',
  422 => 'Rhon422',
  423 => 'Annwyn423',
  424 => 'Clarent424',
  425 => 'LLamrei425',
  426 => 'Caval426',
  427 => 'Celidon427',
  428 => 'Badon428',
  429 => 'Glessic429',
  430 => 'Culwich430',
  431 => 'Pridwen431',
  432 => 'Goswhit432',
  433 => 'Arthur433',
  434 => 'Excalibur434',
  435 => 'Galantine435',
  436 => 'Arondight436',
  437 => 'Caliburn437',
  438 => 'Rhon438',
  439 => 'Annwyn439',
  440 => 'Clarent440',
  441 => 'LLamrei441',
  442 => 'Caval442',
  443 => 'Celidon443',
  444 => 'Badon444',
  445 => 'Glessic445',
  446 => 'Culwich446',
  447 => 'Pridwen447',
  448 => 'Goswhit448',
  449 => 'Arturo449',
  450 => 'Excalibur450',
  451 => 'Galantine451',
  452 => 'Arondight452',
  453 => 'Caliburn453',
  454 => 'Rhon454',
  455 => 'Annwyn455',
  456 => 'Clarent456',
  457 => 'LLamrei457',
  458 => 'Caval458',
  459 => 'Celidon459',
  460 => 'Badon460',
);

require $rootPath.'vendor/autoload.php';

?>